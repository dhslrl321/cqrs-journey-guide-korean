<div align="center">

#### [목차 바로가기](https://github.com/dhslrl321/cqrs-journey-guide-korean/blob/master/Table%20of%20Contents.md)

</div>

---

# Patterns and concepts

이번 여정에서, 대부분의 핵심적인 첼린지는, 팀이 어떻게 V1 에서 V2 로 마이그레이션을 잘 수행하는가에 달려있다.

이 섹션은 이러한 첼린지를 포함한다

# Handling Changes to event definitions

팀이 v2 릴리즈를 위해서 요구사항을 분석할 때, 새로운 기능을 지원해야 하기 떄문에 Order 와 Registration 도메인의 이벤트가 변경되어저야 한다는 것을 알게되었다.

`RegistrationProcessManager` 가 변경되면 사용자가 0원 결제 시점에 더 나은 ux 를 제공할 것이다.

Order 와 Registration Bounded Context 는 이벤트 소싱을 사용한다. 그래서 만약 v2 로 마이그레이션을 한다면 이벤트 스토어는 old event 와 새로운 이벤트를 모두 저장하게 될 것이다.

이벤트가 replayed 될 때, 시스템은 old 와 new 이벤트를 모두 올바르게 처리하고 수용할 수 있어야 한다.

결국 팀은 이러한 것을 지원하기 위해 두가지 접근법을 사용하기로 했다

## 1. 인프라스트럭쳐 내에서 이벤트 메시지를 매핑하고 필터링하기

인프라스트럭쳐 내에서 이벤트 메시지를 매핑하고 필터링하는(mapping and filtering) 것이 한가지 방법이다.

이 방법은 오래된 이벤트 메시지와 메시지 포맷을 도메인에 도달하기 전에 인프라의 어느 한 지점에서 변환을 해서 처리하는 것을 의미한다.

더 이상 관련이 없는 오래된 메시지를 필터링하고 매핑하여 새로운 버전의 메시지로 변환해준다.

이 방법은 처음에는 더 복잡한 접근 법이지만, 도메인이 현재 이벤트의 set 만 이해하기 때문에 도메인을 더욱 순수하게 유지할 수 있는 장점이 있다.

## 2. 다수의 버전의 메시지를 애그리거트 내에서 처리하기

다양한 버전의 메시지를 애그리거트가 처리하도록 하는것도 방법이다.

이 방법은 모든 종류의 메시지가 (old 혹은 new) 모두 애그리거트로 전달되기 때문에 애그리거트에서 이 메시지와 버전에 따라서 각각 처리를 해줘야 한다.

비교적 구현이 간단하여 단기적으로는 장점이 될 수 있으나 결국 도메인 모델이 레거시 EventHandler 로 오염될 가능성이 있다.

우리는 코드 변경량을 최소화하기 떄문에 V2 릴리즈에 대해 이 옵션을 선택하기로 했다.

---
